{% extends "base.html" %}

{% block extra_css %}<link rel="stylesheet" href="{{ url_for('static', filename='css/notifications.css') }}">{% endblock %}

{% block title %}Th√¥ng B√°o - Metro FaceCheck{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h2>Th√¥ng B√°o V√© S·∫Øp T·ªõi Gi·ªù</h2>
        <p>ƒê√¢y l√† c√°c v√© l∆∞·ª£t c·ªßa b·∫°n s·∫Øp ƒë·∫øn gi·ªù kh·ªüi h√†nh.</p>
    </div>

    <div class="notification-list">
        {% if upcoming_tickets %}
            {% for ticket in upcoming_tickets %}
            <div class="notification-card" data-departure-time="{{ ticket.expected_departure_time.isoformat() }}">
                <div class="card-icon">üéüÔ∏è</div>
                <div class="card-content">
                    <h4>{{ ticket.from_station_name }} ‚Üí {{ ticket.to_station_name }}</h4>
                    <p>
                        D·ª± ki·∫øn kh·ªüi h√†nh l√∫c: 
                        <strong>{{ ticket.expected_departure_time.strftime('%H:%M ng√†y %d/%m/%Y') }}</strong>
                    </p>
                    <div class="countdown-timer" id="countdown-{{ ticket.id }}">
                        </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">üîï</div>
            <h3>Kh√¥ng c√≥ th√¥ng b√°o</h3>
            <p>B·∫°n kh√¥ng c√≥ v√© l∆∞·ª£t n√†o s·∫Øp kh·ªüi h√†nh trong 24 gi·ªù t·ªõi.</p>
            <a href="/buy_ticket" class="btn btn-primary btn-lg">Mua V√© Ngay</a>
        </div>
        {% endif %}
    </div>
</div>

<script data-current-time="{{ current_time_iso }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // L·∫•y th·ªùi gian hi·ªán t·∫°i t·ª´ server (ƒë·ªÉ tr√°nh l·ªách m√∫i gi·ªù client)
        const serverNow = new Date(document.querySelector('script[data-current-time]').dataset.currentTime);
        const notificationCards = document.querySelectorAll('.notification-card');

        function updateTimers() {
            // C·∫≠p nh·∫≠t th·ªùi gian hi·ªán t·∫°i m·ªói gi√¢y
            serverNow.setSeconds(serverNow.getSeconds() + 1);
            
            notificationCards.forEach(card => {
                const departureTime = new Date(card.dataset.departureTime);
                const countdownEl = card.querySelector('.countdown-timer');
                
                // T√≠nh to√°n th·ªùi gian ch√™nh l·ªách (t√≠nh b·∫±ng gi√¢y)
                const diffSeconds = Math.floor((departureTime - serverNow) / 1000);

                if (diffSeconds <= 0) {
                    countdownEl.className = 'countdown-timer expired';
                    countdownEl.textContent = 'ƒê√£ ƒë·∫øn gi·ªù kh·ªüi h√†nh';
                    return;
                }

                // T√≠nh to√°n gi·ªù, ph√∫t, gi√¢y
                const hours = Math.floor(diffSeconds / 3600);
                const minutes = Math.floor((diffSeconds % 3600) / 60);
                const seconds = diffSeconds % 60;

                let message = `C√≤n: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // ‚ú® LOGIC NH·∫ÆC NH·ªû 30 PH√öT ‚ú®
                if (diffSeconds <= 1800) { // D∆∞·ªõi 30 ph√∫t (1800 gi√¢y)
                    countdownEl.className = 'countdown-timer urgent';
                    countdownEl.textContent = `üö® S·∫ÆP KH·ªûI H√ÄNH! (${message})`;
                } else {
                    countdownEl.className = 'countdown-timer normal';
                    countdownEl.textContent = message;
                }
            });
        }

        if (notificationCards.length > 0) {
            updateTimers(); // Ch·∫°y l·∫ßn ƒë·∫ßu
            setInterval(updateTimers, 1000); // C·∫≠p nh·∫≠t m·ªói gi√¢y
        }
    });
</script>
{% endblock %}