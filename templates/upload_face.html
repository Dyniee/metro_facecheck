{% extends "base.html" %}

{% block extra_css %}
<style>
    /* Custom CSS cho trang upload_face */
    .page-container {
        max-width: 800px;
        margin: var(--spacing-xxl) auto;
        padding: var(--spacing-xl);
        background: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        text-align: center;
    }

    .page-header h2 {
        color: var(--primary-dark);
        margin-bottom: var(--spacing-sm);
    }

    .page-header p {
        color: var(--gray);
        font-size: 1.1rem;
        margin-bottom: var(--spacing-xl);
    }

    .alert {
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        border-radius: var(--radius-md);
        font-weight: 600;
        text-align: left;
    }

    .alert-error {
        background-color: var(--error-light);
        color: var(--error-dark);
        border: 1px solid var(--error);
    }

    .alert-success {
        background-color: var(--success-light);
        color: var(--success-dark);
        border: 1px solid var(--success);
    }

    .upload-section {
        margin-bottom: var(--spacing-xxl);
    }

    .upload-section h3 {
        color: var(--secondary-dark);
        margin-bottom: var(--spacing-lg);
        border-bottom: 1px solid var(--gray-light);
        padding-bottom: var(--spacing-md);
    }

    /* Webcam View */
    .webcam-container {
        position: relative;
        width: 100%;
        max-width: 640px; /* Chiều rộng tối đa của video */
        margin: 0 auto var(--spacing-lg);
        border: 2px solid var(--primary);
        border-radius: var(--radius-md);
        overflow: hidden; /* Đảm bảo video không tràn ra ngoài */
        background-color: #333;
    }

    #webcamVideo {
        width: 100%;
        height: auto;
        display: block;
        transform: scaleX(-1); /* Lật ngang video để giống gương */
    }

    #webcamCanvas {
        display: none; /* Ban đầu ẩn canvas */
        width: 100%;
        height: auto;
    }

    .webcam-controls {
        display: flex;
        justify-content: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
    }

    /* File Upload */
    .file-upload-container {
        margin-top: var(--spacing-xl);
        padding: var(--spacing-xl);
        border: 2px dashed var(--gray-light);
        border-radius: var(--radius-md);
        background-color: var(--background-light);
        text-align: center;
    }

    .file-upload-container label {
        display: block;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-dark);
        margin-bottom: var(--spacing-md);
    }

    .file-upload-container input[type="file"] {
        display: none; /* Ẩn input mặc định */
    }

    .file-upload-container .custom-file-upload {
        display: inline-block;
        background-color: var(--secondary);
        color: var(--white);
        padding: var(--spacing-sm) var(--spacing-lg);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .file-upload-container .custom-file-upload:hover {
        background-color: var(--secondary-dark);
    }
    
    #fileNameDisplay {
        margin-top: var(--spacing-sm);
        font-size: 0.9rem;
        color: var(--gray);
    }

    .upload-actions {
        margin-top: var(--spacing-xl);
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 0.8s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block title %}Đăng Ký Khuôn Mặt - Metro FaceCheck{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h2>Đăng Ký Khuôn Mặt Để Check-in</h2>
        <p>Để sử dụng hệ thống, bạn cần đăng ký khuôn mặt của mình. Bạn có thể chụp ảnh hoặc tải lên một bức ảnh.</p>
    </div>

    <div id="message-area"></div>

    <div class="upload-section">
        <h3>Chụp Ảnh Từ Webcam</h3>
        <div class="webcam-container">
            <video id="webcamVideo" autoplay playsinline></video>
            <canvas id="webcamCanvas" width="640" height="480"></canvas>
        </div>
        <div class="webcam-controls">
            <button id="startWebcamBtn" class="btn btn-secondary">Bật Webcam</button>
            <button id="takePhotoBtn" class="btn btn-primary" disabled>Chụp Ảnh</button>
            <button id="retakePhotoBtn" class="btn btn-warning" style="display:none;">Chụp Lại</button>
        </div>
    </div>

    <div class="upload-section">
        <h3>Hoặc Tải Lên Ảnh Có Sẵn</h3>
        <div class="file-upload-container">
            <label for="fileUploadInput">Chọn một tệp ảnh khuôn mặt</label>
            <input type="file" id="fileUploadInput" accept="image/*">
            <label for="fileUploadInput" class="custom-file-upload">
                Chọn File
            </label>
            <p id="fileNameDisplay">Chưa có tệp nào được chọn</p>
            <img id="imagePreview" src="#" alt="Xem trước ảnh" style="display:none; max-width: 100%; margin-top: 20px; border-radius: 8px; box-shadow: var(--shadow-md);">
        </div>
    </div>
    
    <div class="upload-actions">
        <button id="uploadBtn" class="btn btn-success btn-lg" disabled>
            Tải Lên Khuôn Mặt
        </button>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', async function() {
        const webcamVideo = document.getElementById('webcamVideo');
        const webcamCanvas = document.getElementById('webcamCanvas');
        const context = webcamCanvas.getContext('2d', { willReadFrequently: true });
        const startWebcamBtn = document.getElementById('startWebcamBtn');
        const takePhotoBtn = document.getElementById('takePhotoBtn');
        const retakePhotoBtn = document.getElementById('retakePhotoBtn');
        const fileUploadInput = document.getElementById('fileUploadInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const imagePreview = document.getElementById('imagePreview');
        const uploadBtn = document.getElementById('uploadBtn');
        const messageArea = document.getElementById('message-area');

        let stream;
        let capturedBlob = null; // Lưu trữ ảnh đã chụp/chọn
        let currentUploadSource = null; // 'webcam' hoặc 'file'

        // === CÁC HÀM TIỆN ÍCH ===
        function showMessage(type, message) {
            messageArea.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            // Tự động ẩn sau 5 giây
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        function disableAllUploadActions(status) {
            startWebcamBtn.disabled = status;
            takePhotoBtn.disabled = status;
            retakePhotoBtn.disabled = status;
            fileUploadInput.disabled = status;
            uploadBtn.disabled = status;
        }

        // === LOGIC WEBCAM ===
        startWebcamBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcamVideo.srcObject = stream;
                webcamVideo.style.display = 'block';
                webcamCanvas.style.display = 'none';
                takePhotoBtn.disabled = false;
                startWebcamBtn.textContent = 'Webcam Đang Bật';
                startWebcamBtn.disabled = true;
                retakePhotoBtn.style.display = 'none';
                capturedBlob = null;
                uploadBtn.disabled = true; // Vô hiệu hóa nút tải lên cho đến khi có ảnh
                imagePreview.style.display = 'none';
                imagePreview.src = '#'; // Xóa ảnh preview nếu có
                fileUploadInput.value = ''; // Xóa input file
                fileNameDisplay.textContent = 'Chưa có tệp nào được chọn';
            } catch (err) {
                console.error("Lỗi truy cập webcam: ", err);
                showMessage('error', 'Không thể truy cập webcam. Vui lòng kiểm tra quyền.');
            }
        });

        takePhotoBtn.addEventListener('click', () => {
            webcamCanvas.width = webcamVideo.videoWidth;
            webcamCanvas.height = webcamVideo.videoHeight;
            context.drawImage(webcamVideo, 0, 0, webcamCanvas.width, webcamCanvas.height);
            
            webcamVideo.style.display = 'none';
            webcamCanvas.style.display = 'block';
            
            takePhotoBtn.style.display = 'none';
            retakePhotoBtn.style.display = 'inline-block';
            uploadBtn.disabled = false; // Kích hoạt nút tải lên

            // Lấy ảnh từ canvas dưới dạng Blob
            webcamCanvas.toBlob((blob) => {
                capturedBlob = blob;
                currentUploadSource = 'webcam';
            }, 'image/jpeg', 0.9); // Định dạng JPEG, chất lượng 90%
            
            // Dừng stream webcam sau khi chụp để giải phóng tài nguyên
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        });

        retakePhotoBtn.addEventListener('click', async () => {
            // Khởi động lại webcam để chụp lại
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcamVideo.srcObject = stream;
                webcamVideo.style.display = 'block';
                webcamCanvas.style.display = 'none';
                takePhotoBtn.style.display = 'inline-block';
                retakePhotoBtn.style.display = 'none';
                capturedBlob = null;
                uploadBtn.disabled = true;
            } catch (err) {
                console.error("Lỗi truy cập webcam: ", err);
                showMessage('error', 'Không thể truy cập webcam để chụp lại.');
            }
        });

        // === LOGIC TẢI LÊN TỪ FILE ===
        fileUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                fileNameDisplay.textContent = file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    capturedBlob = file; // Gán trực tiếp file object
                    currentUploadSource = 'file';
                    uploadBtn.disabled = false; // Kích hoạt nút tải lên

                    // Dừng webcam nếu đang chạy khi chọn file
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        webcamVideo.srcObject = null;
                        webcamVideo.style.display = 'none';
                        webcamCanvas.style.display = 'none';
                        startWebcamBtn.textContent = 'Bật Webcam';
                        startWebcamBtn.disabled = false;
                        takePhotoBtn.style.display = 'inline-block';
                        takePhotoBtn.disabled = true;
                        retakePhotoBtn.style.display = 'none';
                    }
                };
                reader.readAsDataURL(file);
            } else {
                fileNameDisplay.textContent = 'Chưa có tệp nào được chọn';
                imagePreview.style.display = 'none';
                imagePreview.src = '#';
                capturedBlob = null;
                uploadBtn.disabled = true;
            }
        });

        // === LOGIC TẢI LÊN SERVER ===
        uploadBtn.addEventListener('click', async () => {
            if (!capturedBlob) {
                showMessage('error', 'Vui lòng chụp ảnh hoặc chọn một tệp để tải lên.');
                return;
            }

            disableAllUploadActions(true); // Tắt tất cả các nút khi đang tải lên
            uploadBtn.innerHTML = '<span class="loading-spinner"></span> Đang tải lên...';

            try {
                const formData = new FormData();
                formData.append('face', capturedBlob, `face_${Date.now()}.jpeg`); // Đặt tên file

                const response = await fetch('/api/upload_face', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('success', result.message);
                    // Có thể chuyển hướng hoặc cập nhật giao diện sau khi thành công
                    setTimeout(() => {
                        window.location.href = "{{ url_for('history') }}"; // Chuyển hướng về lịch sử
                    }, 2000);
                } else {
                    showMessage('error', result.error || 'Lỗi không xác định khi tải lên.');
                }
            } catch (error) {
                console.error('Lỗi khi gửi ảnh:', error);
                showMessage('error', 'Đã xảy ra lỗi khi kết nối server: ' + error.message);
            } finally {
                // reset nút và trạng thái
                uploadBtn.innerHTML = 'Tải Lên Khuôn Mặt';
                disableAllUploadActions(false); 
                uploadBtn.disabled = true; // Vô hiệu hóa lại nút tải lên sau khi xử lý
                capturedBlob = null; // Xóa ảnh đã chụp/chọn
                fileNameDisplay.textContent = 'Chưa có tệp nào được chọn';
                imagePreview.style.display = 'none';
                imagePreview.src = '#';
                // Reset webcam state
                startWebcamBtn.textContent = 'Bật Webcam';
                startWebcamBtn.disabled = false;
                takePhotoBtn.style.display = 'inline-block';
                takePhotoBtn.disabled = true;
                retakePhotoBtn.style.display = 'none';
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    webcamVideo.srcObject = null;
                }
            }
        });

        // Khi thoát trang, dừng stream webcam để giải phóng tài nguyên
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    });
</script>
{% endblock %}