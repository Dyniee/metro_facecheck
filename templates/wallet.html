{% extends "base.html" %}

{% block extra_css %}<link rel="stylesheet" href="{{ url_for('static', filename='css/wallet.css') }}">{% endblock %}

{% block title %}V√≠ C·ªßa B·∫°n - Metro FaceCheck{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h2>V√≠ & L·ªãch S·ª≠ Giao D·ªãch</h2>
        <p>Qu·∫£n l√Ω s·ªë d∆∞ v√† xem c√°c giao d·ªãch c·ªßa b·∫°n</p>
    </div>

    <div class="wallet-layout">
        
        <div class="wallet-sidebar">
            <div class="balance-card">
                <p class="balance-label">S·ªë D∆∞ Hi·ªán T·∫°i</p>
                <h3 id="current-balance" class="balance-amount">{{ "{:,.0f} VNƒê".format(balance) }}</h3>
                <p class="balance-note">S·ª≠ d·ª•ng ƒë·ªÉ mua v√© l∆∞·ª£t v√† v√© th√°ng.</p>
            </div>
            
            <div class="top-up-card">
                <h4>N·∫°p Ti·ªÅn V√†o V√≠</h4>
                <p>M√¥ ph·ªèng n·∫°p ti·ªÅn. Nh·∫•n ƒë·ªÉ n·∫°p 100.000 VNƒê (gi√° tr·ªã m·∫∑c ƒë·ªãnh t·ª´ API).</p>
                <button id="top-up-btn" class="btn btn-primary btn-lg btn-block">N·∫°p 100.000 VNƒê</button>
            </div>
        </div>
        
        <div class="transaction-main">
            <h3>L·ªãch S·ª≠ Giao D·ªãch</h3>
            
            {% if transactions %}
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Th·ªùi Gian</th>
                            <th>Lo·∫°i</th>
                            <th>Chi Ti·∫øt</th>
                            <th>S·ªë Ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tx in transactions %}
                        <tr>
                            <td>{{ tx.transaction_time.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td>
                                {% if tx.type == 'top-up' %}
                                    <span class="badge badge-success">N·∫°p ti·ªÅn</span>
                                {% else %}
                                    <span class="badge badge-warning">Mua v√©</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if tx.type == 'top-up' %}
                                    N·∫°p ti·ªÅn v√†o v√≠
                                {% elif tx.ticket_type == 'monthly' %}
                                    Mua <strong>V√© Th√°ng</strong>
                                {% elif tx.ticket_type == 'single' %}
                                    Mua <strong>V√© L∆∞·ª£t</strong> ({{ tx.from_station_name }} ‚Üí {{ tx.to_station_name }})
                                {% else %}
                                    Thanh to√°n
                                {% endif %}
                            </td>
                            <td class="amount {{ 'amount-top-up' if tx.amount > 0 else 'amount-purchase' }}">
                                {{ "{:,.0f} VNƒê".format(tx.amount) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üìù</div>
                <h3>Ch∆∞a c√≥ giao d·ªãch</h3>
                <p>C√°c giao d·ªãch n·∫°p ti·ªÅn v√† mua v√© s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.getElementById('top-up-btn').addEventListener('click', async function() {
        const btn = this;
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span> ƒêang x·ª≠ l√Ω...';
        
        try {
            // G·ªçi API /api/wallet/topup t·ª´ app.py
            const response = await fetch('/api/wallet/topup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: 100000 }) // N·∫°p 100k
            });
            
            const result = await response.json();
            
            if (result.success) {
                // C·∫≠p nh·∫≠t s·ªë d∆∞ tr√™n giao di·ªán
                const balanceEl = document.getElementById('current-balance');
                balanceEl.innerText = result.new_balance.toLocaleString('vi-VN') + ' VNƒê';
                
                alert('N·∫°p ti·ªÅn th√†nh c√¥ng!');
                // T·∫£i l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t l·ªãch s·ª≠
                window.location.reload(); 
            } else {
                throw new Error(result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
            }
            
        } catch (error) {
            alert('L·ªói khi n·∫°p ti·ªÅn: ' + error.message);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });

    // Th√™m CSS cho spinner (v√¨ kh√¥ng c√≥ file CSS ri√™ng)
    const style = document.createElement('style');
    style.innerHTML = `
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}