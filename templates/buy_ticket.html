{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/buy_ticket.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block title %}Mua V√© - Metro FaceCheck{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h2>Mua V√© Metro</h2>
        <p>Ch·ªçn lo·∫°i v√© v√† thanh to√°n b·∫±ng s·ªë d∆∞ c·ªßa b·∫°n</p>
    </div>

    <div class="ticket-form-container">
        
        <div class="wallet-balance-box">
            <span>S·ªë D∆∞ V√≠</span>
            <span class="balance-amount">{{ "{:,.0f} VNƒê".format(balance) }}</span>
            <a href="{{ url_for('wallet_page') }}" class="btn-top-up">N·∫°p Ti·ªÅn</a>
        </div>
        
        <div id="habit-suggestion-box" class="habit-suggestion-box" style="display: none;">
            <span class="habit-icon">üëã</span>
            <div class="habit-content">
                <p>Mua v√© quen thu·ªôc?</p>
                <strong id="habit-details">Ga B·∫øn Th√†nh ‚Üí Ga Th·ªß ƒê·ª©c (kho·∫£ng 8:00)</strong>
            </div>
            <button type="button" id="apply-habit-btn" class="btn-apply-habit">Ch·ªçn Nhanh</button>
        </div>
        {% if error %}
            <div class="alert alert-error" style="margin-bottom: 1.5rem;">
                {{ error }}
            </div>
        {% endif %}

        {% if has_active and not has_face %}
            <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                B·∫°n ƒë√£ c√≥ v√© th√°ng nh∆∞ng ch∆∞a ƒëƒÉng k√Ω khu√¥n m·∫∑t. Vui l√≤ng ƒëƒÉng k√Ω khu√¥n m·∫∑t ƒë·ªÉ k√≠ch ho·∫°t v√©.
            </div>
            <a href="{{ url_for('upload_face_page') }}" class="btn btn-primary btn-lg btn-block" style="margin-bottom:1rem;">ƒêƒÉng K√Ω Khu√¥n M·∫∑t</a>
        {% endif %}

        <div class="ticket-form">
            <div class="ticket-tabs">
                <button type="button" class="tab-btn active" data-tab="single">
                    <span class="tab-icon">üéüÔ∏è</span> Mua V√© L∆∞·ª£t
                </button>
                <button type="button" class="tab-btn" data-tab="monthly">
                    <span class="tab-icon">üìÖ</span> Mua V√© Th√°ng
                </button>
            </div>

            <form method="POST" id="buy-ticket-form">
                <input type="hidden" id="ticket_type_input" name="ticket_type" value="single">

                <div id="single" class="tab-content active">
                    <div class="form-section">
                        <h3>B∆∞·ªõc 1: Ch·ªçn Ga ƒêi v√† ƒê·∫øn</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="from_station">Ga ƒêi</label>
                                <select id="from_station" name="from_station" required>
                                    <option value="">-- Ch·ªçn ga ƒëi --</option>
                                    {% for station in stations %}
                                        <option value="{{ station.station_name }}">{{ station.station_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="to_station">Ga ƒê·∫øn</label>
                                <select id="to_station" name="to_station" required>
                                    <option value="">-- Ch·ªçn ga ƒë·∫øn --</option>
                                    {% for station in stations %}
                                        <option value="{{ station.station_name }}">{{ station.station_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>B∆∞·ªõc 2: Ch·ªçn Th·ªùi Gian ƒêi</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="valid_date">Ch·ªçn Ng√†y ƒêi</label>
                                <input type="text" id="valid_date" name="valid_date" required placeholder="Ch·ªçn ng√†y...">
                            </div>
                            <div class="form-group">
                                <label for="departure_time">Gi·ªù D·ª± Ki·∫øn (5:00 - 23:30)</label>
                                <input type="text" id="departure_time" name="departure_time" required placeholder="Ch·ªçn gi·ªù...">
                            </div>
                        </div>
                        
                        <div id="suggestion-box" class="suggestion-box" style="display: none;">
                            <span id="suggestion-icon"></span>
                            <span id="suggestion-text"></span>
                        </div>
                    </div>

                    <div class="form-section price-display-box">
                        <h3>Gi√° V√© L∆∞·ª£t</h3>
                        <div class="price-display">
                            <span id="single-ticket-price">0</span> VNƒê
                        </div>
                        <p id="price-error" class="price-error-message"></p>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg btn-block">
                        Thanh To√°n V√© L∆∞·ª£t
                    </button>
                </div>

                <div id="monthly" class="tab-content">
                    <div class="form-section">
                        <h3>V√© Th√°ng - 30 Ng√†y</h3>
                        
                        {% if user_type == 'student' %}
                            <div class="ticket-info-box student">
                                <h4>G√≥i H·ªçc sinh/Sinh vi√™n</h4>
                                <p>Gi√° ∆∞u ƒë√£i: <strong>150,000 VNƒê</strong></p>
                            </div>
                        {% else %}
                            <div class="ticket-info-box general">
                                <h4>G√≥i Ph·ªï th√¥ng</h4>
                                <p>Gi√° v√©: <strong>300,000 VNƒê</strong></p>
                            </div>
                        {% endif %}
                        
                        <p style="color: #666; font-size: 0.95rem; line-height: 1.6;">
                            ‚úì S·ª≠ d·ª•ng kh√¥ng gi·ªõi h·∫°n trong 30 ng√†y<br>
                            ‚úì H·ªó tr·ª£ ƒëi qua t·∫•t c·∫£ {{ stations|length }} ga metro<br>
                            ‚úì Ch·ªâ c·∫ßn ƒëƒÉng k√Ω khu√¥n m·∫∑t m·ªôt l·∫ßn<br>
                        </p>
                    </div>
                    
                    <div class="form-section">
                        <h3>Ch·ªçn Ga M·∫∑c ƒê·ªãnh</h3>
                        <p style="color: #666; margin-bottom: 1rem;">
                            (V√© th√°ng cho ph√©p ƒëi t·∫•t c·∫£ c√°c ga, ƒë√¢y ch·ªâ l√† ga ƒëi/ƒë·∫øn b·∫°n th∆∞·ªùng d√πng)
                        </p>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="monthly_from_station">Ga ƒêi (th∆∞·ªùng v√†o)</label>
                                <select id="monthly_from_station" name="station_from_id" required>
                                    <option value="">-- Ch·ªçn ga ƒëi --</option>
                                    {% for station in stations %}
                                        <option value="{{ station.station_name }}">{{ station.station_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="monthly_to_station">Ga ƒê·∫øn (th∆∞·ªùng ƒë·∫øn)</label>
                                <select id="monthly_to_station" name="station_to_id" required>
                                    <option value="">-- Ch·ªçn ga ƒë·∫øn --</option>
                                    {% for station in stations %}
                                        <option value="{{ station.station_name }}">{{ station.station_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-lg btn-block" style="margin-top: 2rem;">
                        Thanh To√°n V√© Th√°ng
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // === KH·ªûI T·∫†O L·ªäCH/GI·ªú ===
        const datePicker = flatpickr("#valid_date", {
            minDate: "today",
            dateFormat: "Y-m-d",
            defaultDate: "today",
            onChange: function(selectedDates, dateStr, instance) {
                fetchTravelSuggestion(); 
            }
        });
        
        const timePicker = flatpickr("#departure_time", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            defaultDate: "09:00",
            minTime: "05:00",
            maxTime: "23:30",
            time_24hr: true,
            onChange: function(selectedDates, dateStr, instance) {
                fetchTravelSuggestion(); 
            }
        });
        
        // === LOGIC CHUY·ªÇN TAB ===
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const hiddenTicketType = document.getElementById('ticket_type_input');
        const form = document.getElementById('buy-ticket-form');
        
        const singleInputs = {
            from: document.getElementById('from_station'),
            to: document.getElementById('to_station'),
            date: datePicker.input,
            time: timePicker.input
        };
        
        const monthlyInputs = {
            from: document.getElementById('monthly_from_station'),
            to: document.getElementById('monthly_to_station')
        };

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                const tabId = button.dataset.tab;
                document.getElementById(tabId).classList.add('active');
                hiddenTicketType.value = tabId;
                
                if (tabId === 'single') {
                    setRequired(singleInputs, true);
                    setRequired(monthlyInputs, false);
                } else {
                    setRequired(singleInputs, false);
                    setRequired(monthlyInputs, true);
                }
            });
        });
        
        function setRequired(inputs, isRequired) {
            for (const key in inputs) {
                if (isRequired) {
                    inputs[key].setAttribute('required', 'required');
                } else {
                    inputs[key].removeAttribute('required');
                }
            }
        }
        
        setRequired(singleInputs, true);
        setRequired(monthlyInputs, false);

        // === LOGIC T√çNH GI√Å V√â L∆Ø·ª¢T ===
        const fromStation = document.getElementById('from_station');
        const toStation = document.getElementById('to_station');
        const priceDisplay = document.getElementById('single-ticket-price');
        const priceError = document.getElementById('price-error');

        async function fetchTicketPrice() {
            const from = fromStation.value;
            const to = toStation.value;
            if (!from || !to) { priceDisplay.textContent = '...'; priceError.textContent = ''; return; }
            if (from === to) { priceDisplay.textContent = '0'; priceError.textContent = 'Vui l√≤ng ch·ªçn ga ƒëi v√† ga ƒë·∫øn kh√°c nhau.'; return; }
            priceError.textContent = ''; priceDisplay.textContent = '...';
            try {
                const response = await fetch('/api/calculate_price', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ from_station: from, to_station: to })
                });
                if (!response.ok) { throw new Error('L·ªói m√°y ch·ªß'); }
                const result = await response.json();
                if (result.success) {
                    priceDisplay.textContent = result.price.toLocaleString('vi-VN');
                } else {
                    priceError.textContent = result.error; priceDisplay.textContent = 'L·ªói';
                }
            } catch (error) {
                priceError.textContent = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß.'; priceDisplay.textContent = 'L·ªói';
            }
        }
        fromStation.addEventListener('change', fetchTicketPrice);
        toStation.addEventListener('change', fetchTicketPrice);

        // === LOGIC G·ª¢I √ù (AI) L·ªäCH T√ÄU ===
        const suggestionBox = document.getElementById('suggestion-box');
        const suggestionIcon = document.getElementById('suggestion-icon');
        const suggestionText = document.getElementById('suggestion-text');

        async function fetchTravelSuggestion() {
            const date = datePicker.input.value;
            const time = timePicker.input.value;
            if (!date || !time) return;
            try {
                suggestionBox.style.display = 'flex';
                suggestionIcon.textContent = '‚è≥';
                suggestionText.textContent = 'ƒêang ph√¢n t√≠ch l·ªãch t√†u...';
                const response = await fetch('/api/get_travel_suggestion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: date, time: time })
                });
                const result = await response.json();
                if (result.success) {
                    suggestionText.textContent = result.suggestion;
                    if (result.frequency <= 8) { 
                        suggestionIcon.textContent = 'üî•'; 
                        suggestionBox.className = 'suggestion-box high-traffic';
                    } else if (result.frequency == 10) { 
                        suggestionIcon.textContent = 'üëç'; 
                        suggestionBox.className = 'suggestion-box normal-traffic';
                    } else { 
                        suggestionIcon.textContent = '‚úÖ'; 
                        suggestionBox.className = 'suggestion-box low-traffic';
                    }
                } else { throw new Error(result.error); }
            } catch (error) {
                suggestionIcon.textContent = '‚ùå';
                suggestionText.textContent = 'Kh√¥ng th·ªÉ t·∫£i g·ª£i √Ω: ' + error.message;
                suggestionBox.className = 'suggestion-box error';
            }
        }
        fetchTravelSuggestion(); // G·ªçi l·∫ßn ƒë·∫ßu
        
        
        // === ‚ú® GIAI ƒêO·∫†N 3: H√ÄM G·ªåI API G·ª¢I √ù TH√ìI QUEN (M·ªöI) ‚ú® ===
        const habitBox = document.getElementById('habit-suggestion-box');
        const habitDetails = document.getElementById('habit-details');
        const applyHabitBtn = document.getElementById('apply-habit-btn');
        
        async function fetchUserHabit() {
            try {
                const response = await fetch('/api/get_user_habits'); //
                const result = await response.json();

                if (result.success && result.habit) {
                    const habit = result.habit;
                    // Hi·ªÉn th·ªã text
                    habitDetails.textContent = `${habit.from_station_name} ‚Üí ${habit.to_station_name} (kho·∫£ng ${habit.habit_hour}:00)`;
                    habitBox.style.display = 'flex';

                    // L∆∞u tr·ªØ d·ªØ li·ªáu th√≥i quen v√†o n√∫t
                    applyHabitBtn.dataset.from = habit.from_station_name;
                    applyHabitBtn.dataset.to = habit.to_station_name;
                    applyHabitBtn.dataset.hour = habit.habit_hour;
                } else {
                    habitBox.style.display = 'none'; // ·∫®n n·∫øu kh√¥ng c√≥ th√≥i quen
                }
            } catch (error) {
                console.error("L·ªói t·∫£i th√≥i quen:", error);
                habitBox.style.display = 'none';
            }
        }

        // G·∫Øn s·ª± ki·ªán click cho n√∫t "Ch·ªçn Nhanh"
        applyHabitBtn.addEventListener('click', function() {
            const data = this.dataset;
            
            // 1. T·ª± ƒë·ªông ƒëi·ªÅn form
            singleInputs.from.value = data.from;
            singleInputs.to.value = data.to;
            
            // 2. Set gi·ªù (v√≠ d·ª•: 8:00)
            timePicker.setDate(data.hour + ':00', true); // 'true' ƒë·ªÉ trigger event
            
            // 3. Set ng√†y l√† h√¥m nay (m·∫∑c ƒë·ªãnh)
            datePicker.setDate(new Date(), true); // 'true' ƒë·ªÉ trigger event

            // 4. (Quan tr·ªçng) Trigger c√°c h√†m API ƒë·ªÉ c·∫≠p nh·∫≠t gi√° v√† g·ª£i √Ω l·ªãch t√†u
            // (Ch√∫ng ta trigger s·ª± ki·ªán 'change' th·ªß c√¥ng)
            singleInputs.from.dispatchEvent(new Event('change'));
            singleInputs.to.dispatchEvent(new Event('change'));
            
            // 5. Chuy·ªÉn sang tab v√© l∆∞·ª£t (n·∫øu ƒëang ·ªü tab v√© th√°ng)
            document.querySelector('.tab-btn[data-tab="single"]').click();
            
            // 6. Cu·ªôn xu·ªëng form
            singleInputs.from.focus();
        });

        // G·ªçi h√†m khi t·∫£i trang
        fetchUserHabit();
        // === ‚ú® H·∫æT GIAI ƒêO·∫†N 3 ‚ú® ===
        
    });
</script>
{% endblock %}